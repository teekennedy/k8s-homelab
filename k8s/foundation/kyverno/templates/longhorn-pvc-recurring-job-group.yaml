apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: longhorn-drop-default-group-when-nondefault-present
  namespace: {{ .Release.Namespace }}
spec:
  validationFailureAction: audit
  background: false
  rules:
    - name: remove-default-group-label
      match:
        any:
          - resources:
              kinds: ["PersistentVolumeClaim"]
      preconditions:
        all:
          # A) Does the PVC have ANY non-default recurring-job group label?
          #    (i.e., any key starting with the prefix and not exactly .../default)
          - key: "{{ `{{ length(keys(request.object.metadata.labels)[?contains(@, 'recurring-job-group.longhorn.io/') && @ != 'recurring-job-group.longhorn.io/default']) }}` }}"
            operator: GreaterThan
            value: 0

          # B) Does the PVC currently have the default group label at all?
          - key: "{{ `{{ contains(keys(request.object.metadata.labels), 'recurring-job-group.longhorn.io/default') }}` }}"
            operator: Equals
            value: true

      mutate:
        patchesJson6902: |-
          - op: remove
            path: /metadata/labels/recurring-job-group.longhorn.io~1default
      skipBackgroundRequests: true
