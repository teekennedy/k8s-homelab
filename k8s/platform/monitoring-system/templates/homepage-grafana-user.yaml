{{- $config := index .Values "kube-prometheus-stack" "homepage-grafana" | default dict -}}
{{- if (index $config "enabled") -}}
{{- $user := index $config "user" | default dict -}}
{{- $secret := index $config "secret" | default dict -}}
{{- $username := default "homepage" (index $user "name") -}}
{{- $email := default "homepage@msng.to" (index $user "email") -}}
{{- $secretName := default "homepage-grafana-credentials" (index $secret "name") -}}
{{- $grafanaService := printf "%s-grafana" .Release.Name -}}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ .Release.Namespace }}
  annotations:
    secret-generator.v1.mittwald.de/type: basic-auth
    secret-generator.v1.mittwald.de/basic-auth-username: {{ $username }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: homepage-grafana-user
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "2"
    helm.sh/hook: post-install,post-upgrade
spec:
  backoffLimit: 5
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: provision
          image: alpine:3.22.2
          command:
            - sh
            - -c
          args:
            - |
              set -euo pipefail
              apk add --no-cache curl jq
              grafana_url="http://{{ $grafanaService }}"

              timeout 300 sh -c "until curl -sf \"${grafana_url}/api/health\" >/dev/null; do sleep 5; done"

              user_json=$(curl -sf -u "${GRAFANA_ADMIN_USER}:${GRAFANA_ADMIN_PASSWORD}" "${grafana_url}/api/users/lookup?loginOrEmail=${HOMEPAGE_GRAFANA_USERNAME}" || true)
              user_id=$(echo "${user_json}" | jq -r '.id // empty')

              if [ -z "${user_id}" ]; then
                curl -sf -u "${GRAFANA_ADMIN_USER}:${GRAFANA_ADMIN_PASSWORD}" \
                  -H "Content-Type: application/json" \
                  -X POST \
                  -d "{\"name\":\"Homepage\",\"email\":\"${HOMEPAGE_GRAFANA_EMAIL}\",\"login\":\"${HOMEPAGE_GRAFANA_USERNAME}\",\"password\":\"${HOMEPAGE_GRAFANA_PASSWORD}\"}" \
                  "${grafana_url}/api/admin/users" || true

                user_json=$(curl -sf -u "${GRAFANA_ADMIN_USER}:${GRAFANA_ADMIN_PASSWORD}" "${grafana_url}/api/users/lookup?loginOrEmail=${HOMEPAGE_GRAFANA_USERNAME}" || true)
                user_id=$(echo "${user_json}" | jq -r '.id // empty')
              fi

              if [ -z "${user_id}" ]; then
                echo "Unable to find or create Grafana user ${HOMEPAGE_GRAFANA_USERNAME}" >&2
                exit 1
              fi

              curl -sf -u "${GRAFANA_ADMIN_USER}:${GRAFANA_ADMIN_PASSWORD}" \
                -H "Content-Type: application/json" \
                -X PUT \
                -d "{\"password\":\"${HOMEPAGE_GRAFANA_PASSWORD}\"}" \
                "${grafana_url}/api/admin/users/${user_id}/password"

              role_name="homepage-server-stats"
              role_json="$(mktemp)"
              role_code=$(curl -s -o "${role_json}" -w "%{http_code}" \
                -u "${GRAFANA_ADMIN_USER}:${GRAFANA_ADMIN_PASSWORD}" \
                "${grafana_url}/api/access-control/roles" || true)

              if [ "${role_code}" != "200" ]; then
                echo "Grafana access-control API unavailable (status ${role_code}); skipping role assignment"
                exit 0
              fi

              role_uid=$(jq -r ".[] | select(.name==\"${role_name}\") | .uid" "${role_json}" | head -n1)

              if [ -z "${role_uid}" ]; then
                role_payload=$(cat <<'JSON'
              {"name":"homepage-server-stats","description":"Homepage server stats","permissions":[{"action":"server.stats:read","scope":"*"}]}
              JSON
                )
                role_uid=$(curl -sf -u "${GRAFANA_ADMIN_USER}:${GRAFANA_ADMIN_PASSWORD}" \
                  -H "Content-Type: application/json" \
                  -X POST \
                  -d "${role_payload}" \
                  "${grafana_url}/api/access-control/roles" | jq -r '.uid // empty')
              fi

              if [ -z "${role_uid}" ]; then
                echo "Unable to find or create Grafana role ${role_name}" >&2
                exit 1
              fi

              assign_code=$(curl -s -o /dev/null -w "%{http_code}" \
                -u "${GRAFANA_ADMIN_USER}:${GRAFANA_ADMIN_PASSWORD}" \
                -X POST \
                "${grafana_url}/api/access-control/roles/${role_uid}/users/${user_id}")

              if [ "${assign_code}" != "200" ] && [ "${assign_code}" != "204" ] && [ "${assign_code}" != "409" ]; then
                assign_code=$(curl -s -o /dev/null -w "%{http_code}" \
                  -u "${GRAFANA_ADMIN_USER}:${GRAFANA_ADMIN_PASSWORD}" \
                  -H "Content-Type: application/json" \
                  -X POST \
                  -d "{\"roles\":[\"${role_uid}\"]}" \
                  "${grafana_url}/api/access-control/users/${user_id}/roles")

                if [ "${assign_code}" != "200" ] && [ "${assign_code}" != "204" ] && [ "${assign_code}" != "409" ]; then
                  echo "Unable to assign Grafana role ${role_uid} to user ${user_id} (status ${assign_code})" >&2
                  exit 1
                fi
              fi
          env:
            - name: GRAFANA_ADMIN_USER
              valueFrom:
                secretKeyRef:
                  name: {{ $grafanaService }}
                  key: username
            - name: GRAFANA_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $grafanaService }}
                  key: password
            - name: HOMEPAGE_GRAFANA_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ $secretName }}
                  key: username
            - name: HOMEPAGE_GRAFANA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $secretName }}
                  key: password
            - name: HOMEPAGE_GRAFANA_EMAIL
              value: {{ $email | quote }}
{{- end }}
