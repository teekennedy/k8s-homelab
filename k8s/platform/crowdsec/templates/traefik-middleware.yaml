{{- if .Values.traefikBouncer.enabled }}
# Traefik Middleware for CrowdSec bouncer
#
# Apply this to Ingresses using the annotation:
#   traefik.ingress.kubernetes.io/router.middlewares: crowdsec-crowdsec-bouncer@kubernetescrd
#
# For IngressRoutes, add to the route:
#   middlewares:
#     - name: crowdsec-bouncer
#       namespace: crowdsec
#
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: crowdsec-bouncer
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: crowdsec
    app.kubernetes.io/component: traefik-bouncer
spec:
  plugin:
    # Plugin name must match the key in traefik's experimental.plugins config
    crowdsec-bouncer:
      # Enable the bouncer
      Enabled: "true"

      # Log level for debugging
      logLevel: {{ .Values.traefikBouncer.logLevel }}

      # CrowdSec operation mode:
      # - "live": Query LAPI for every request
      # - "stream": Decisions cached locally, updated periodically (recommended)
      # - "alone": Use local decisions file only
      crowdsecMode: {{ .Values.traefikBouncer.mode }}

      # CrowdSec LAPI connection settings
      crowdsecLapiScheme: http
      crowdsecLapiHost: crowdsec-service.{{ .Release.Namespace }}.svc.cluster.local:8080

      # API key for bouncer authentication
      # NOTE: You must replace this with a real key generated from CrowdSec LAPI:
      #   kubectl -n crowdsec exec -it deployment/crowdsec-lapi -- cscli bouncers add traefik-bouncer -o raw
      CrowdsecLapiKey: "REPLACE_WITH_REAL_KEY"

      # Update interval for stream mode (in seconds)
      updateIntervalSeconds: {{ .Values.traefikBouncer.updateInterval }}

      # Default ban time in seconds (for stream mode)
      defaultDecisionSeconds: 3600

      # Trust X-Forwarded-For from these IPs (your load balancers/proxies)
      forwardedHeadersTrustedIPs:
        - "10.0.0.0/8"
        - "172.16.0.0/12"
        - "192.168.0.0/16"
{{- end }}
