---
# ServiceAccount for bootstrap job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: authelia-redis-bootstrap
  namespace: {{ .Release.Namespace }}
---
# Role with minimal permissions (read secrets only)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: authelia-redis-bootstrap
  namespace: {{ .Release.Namespace }}
rules:
- apiGroups: [""]
  resources: ["secrets"]
  resourceNames: ["{{ .Values.authelia.secret.existingSecret }}"]
  verbs: ["get"]
---
# RoleBinding to bind ServiceAccount to Role
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: authelia-redis-bootstrap
  namespace: {{ .Release.Namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: authelia-redis-bootstrap
subjects:
- kind: ServiceAccount
  name: authelia-redis-bootstrap
  namespace: {{ .Release.Namespace }}
---
# ConfigMap containing the bootstrap script
apiVersion: v1
kind: ConfigMap
metadata:
  name: authelia-redis-bootstrap-script
  namespace: {{ .Release.Namespace }}
data:
  bootstrap.py: |
{{ .Files.Get "files/redis-bootstrap/bootstrap.py" | indent 4 }}
  pyproject.toml: |
{{ .Files.Get "files/redis-bootstrap/pyproject.toml" | indent 4 }}
  uv.lock: |
{{ .Files.Get "files/redis-bootstrap/uv.lock" | indent 4 }}
---
# Bootstrap Job
apiVersion: batch/v1
kind: Job
metadata:
  name: authelia-redis-bootstrap
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: redis-bootstrap
    app.kubernetes.io/component: redis-bootstrap
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "10"
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/name: redis-bootstrap
        app.kubernetes.io/component: redis-bootstrap
    spec:
      serviceAccountName: authelia-redis-bootstrap
      restartPolicy: OnFailure
      containers:
      - name: bootstrap
        image: ghcr.io/astral-sh/uv:alpine
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Installing dependencies..."
          apk add --no-cache git curl

          echo "Running bootstrap script..."
          cd /bootstrap
          uv run ./bootstrap.py
        env:
        - name: REDIS_SENTINEL_HOST
          value: "redis-sentinel.{{ .Release.Namespace }}.svc.cluster.local"
        - name: REDIS_SENTINEL_PORT
          value: {{ .Values.authelia.configMap.session.redis.port | quote }}
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.authelia.secret.existingSecret }}
              key: session.redis.password.txt
        - name: SENTINEL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.authelia.secret.existingSecret }}
              key: session.redis.sentinel.password.txt
              optional: true
        volumeMounts:
        - name: bootstrap-script
          mountPath: /bootstrap
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "500m"
      volumes:
      - name: bootstrap-script
        configMap:
          name: authelia-redis-bootstrap-script
