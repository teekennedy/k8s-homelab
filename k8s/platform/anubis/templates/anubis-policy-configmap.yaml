# Static policy configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: anubis-policy
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: anubis
    app.kubernetes.io/component: policy
data:
  policies.yaml: |-
    bots:
      - import: (data)/meta/default-config.yaml
      - name: homelab-internal-networks
        action: ALLOW
        remote_addresses:
          - 10.69.0.0/16
          - 10.42.0.0/16
      # Import GeoIP rules managed by geoip-generator CronJob
      - import: /etc/anubis/geoip/geoip-rules.yaml

    thresholds:
      # Requests with no suspicion - allow through
      - name: no-suspicion
        expression: weight <= 0
        action: ALLOW

      # Low suspicion - lightweight meta refresh challenge
      - name: low-suspicion
        expression:
          all:
            - weight > 0
            - weight < 10
        action: CHALLENGE
        challenge:
          algorithm: metarefresh
          difficulty: 1

      # Moderate suspicion - fast proof of work
      - name: moderate-suspicion
        expression:
          all:
            - weight >= 10
            - weight < 20
        action: CHALLENGE
        challenge:
          algorithm: fast
          difficulty: 2

      # High suspicion - harder proof of work
      - name: high-suspicion
        expression:
          all:
            - weight >= 20
            - weight < 30
        action: CHALLENGE
        challenge:
          algorithm: fast
          difficulty: 4

      # Extreme suspicion - difficult proof of work
      - name: extreme-suspicion
        expression: weight >= 30
        action: CHALLENGE
        challenge:
          algorithm: fast
          difficulty: 6
---
# GeoIP rules generated by geoip-generator CronJob
# ArgoCD is configured to ignore differences in this ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: anubis-geoip-policy
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: anubis
    app.kubernetes.io/component: geoip-policy
  annotations:
    argocd.argoproj.io/sync-options: Prune=false
data:
  geoip-rules.yaml: |-
    # Valid anubis configuration that acts as a placeholder until this configmap is replaced by geoip-rule-generator.
    # This rule adjusts weight by 0, effectively doing nothing
    - name: placeholder
      action: WEIGH
      remote_addresses:
        # Subnet reserved for documentation.
        # RFC 5737 https://www.rfc-editor.org/rfc/rfc5737
        - 192.0.2.0/24
