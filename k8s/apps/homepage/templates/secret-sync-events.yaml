{{- $sync := index .Values "secret-sync" | default dict -}}
{{- $events := index $sync "events" | default dict -}}
{{- if and (index $sync "enabled") (index $events "enabled") -}}
{{- $mappings := index $sync "mappings" | default list -}}
{{- $eventBusName := default "homepage-secret-sync" (index $events "eventBusName") -}}
{{- $eventSourceName := default "homepage-secret-sync" (index $events "eventSourceName") -}}
{{- $sensorName := default "homepage-secret-sync" (index $events "sensorName") -}}
{{- $eventSourceServiceAccount := default "homepage-secret-sync-eventsource" (index $events "eventSourceServiceAccount") -}}
{{- $sensorServiceAccount := default "homepage-secret-sync-sensor" (index $events "sensorServiceAccount") -}}
{{- $image := index $sync "image" | default dict -}}
{{- $sourceSecrets := dict -}}
{{- range $mappings -}}
  {{- $source := index . "source" | default dict -}}
  {{- $ns := index $source "namespace" -}}
  {{- $name := index $source "name" -}}
  {{- if and $ns $name -}}
    {{- $key := printf "%s/%s" $ns $name -}}
    {{- if not (hasKey $sourceSecrets $key) -}}
      {{- $_ := set $sourceSecrets $key (dict "namespace" $ns "name" $name) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- $sourceKeys := keys $sourceSecrets | sortAlpha -}}
{{- $sourceNamespaces := dict -}}
{{- $dependencyNames := list -}}
{{- $resourceEntries := dict -}}
{{- $dependencies := list -}}
{{- range $sourceKeys -}}
  {{- $secret := get $sourceSecrets . -}}
  {{- $ns := index $secret "namespace" -}}
  {{- if and $ns (not (hasKey $sourceNamespaces $ns)) -}}
    {{- $_ := set $sourceNamespaces $ns true -}}
  {{- end -}}
  {{- $eventName := printf "secret-%s" (replace (replace (replace . "/" "-") "." "-") "_" "-") | lower -}}
  {{- $dependencyNames = append $dependencyNames $eventName -}}
  {{- $resourceEntry := dict "namespace" (index $secret "namespace") "group" "" "version" "v1" "resource" "secrets" "eventTypes" (list "ADD" "UPDATE") "filter" (dict "fields" (list (dict "key" "metadata.name" "operation" "==" "value" (index $secret "name")))) -}}
  {{- $_ := set $resourceEntries $eventName $resourceEntry -}}
  {{- $dependencies = append $dependencies (dict "name" $eventName "eventSourceName" $eventSourceName "eventName" $eventName) -}}
{{- end -}}
{{- $conditions := join " || " $dependencyNames -}}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ $eventSourceServiceAccount }}
  namespace: {{ .Release.Namespace }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ $sensorServiceAccount }}
  namespace: {{ .Release.Namespace }}
---
{{ range $ns, $_ := $sourceNamespaces }}
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: homepage-secret-sync-eventsource-reader
  namespace: {{ $ns }}
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: homepage-secret-sync-eventsource-reader
  namespace: {{ $ns }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: homepage-secret-sync-eventsource-reader
subjects:
  - kind: ServiceAccount
    name: {{ $eventSourceServiceAccount }}
    namespace: {{ $.Release.Namespace }}
---
{{ end }}
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: homepage-secret-sync-sensor
  namespace: {{ .Release.Namespace }}
rules:
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["create", "get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: homepage-secret-sync-sensor
  namespace: {{ .Release.Namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: homepage-secret-sync-sensor
subjects:
  - kind: ServiceAccount
    name: {{ $sensorServiceAccount }}
    namespace: {{ .Release.Namespace }}
---
apiVersion: argoproj.io/v1alpha1
kind: EventBus
metadata:
  name: {{ $eventBusName }}
  namespace: {{ .Release.Namespace }}
spec:
  nats:
    native:
      replicas: 1
      auth: token
---
apiVersion: argoproj.io/v1alpha1
kind: EventSource
metadata:
  name: {{ $eventSourceName }}
  namespace: {{ .Release.Namespace }}
spec:
  eventBusName: {{ $eventBusName }}
  template:
    serviceAccountName: {{ $eventSourceServiceAccount }}
  resource:
{{ toYaml $resourceEntries | nindent 4 }}
---
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: {{ $sensorName }}
  namespace: {{ .Release.Namespace }}
spec:
  eventBusName: {{ $eventBusName }}
  template:
    serviceAccountName: {{ $sensorServiceAccount }}
  dependencies:
{{ toYaml $dependencies | nindent 4 }}
  triggers:
    - template:
        name: homepage-secret-sync
        k8s:
          group: batch
          version: v1
          resource: jobs
          operation: create
          source:
            resource:
              apiVersion: batch/v1
              kind: Job
              metadata:
                generateName: homepage-secret-sync-
                namespace: {{ .Release.Namespace }}
              spec:
                backoffLimit: 3
                template:
                  spec:
                    serviceAccountName: homepage-secret-sync
                    restartPolicy: OnFailure
                    containers:
                      - name: sync
                        image: {{ printf "%s:%s" (index $image "repository" | default "golang") (index $image "tag" | default "1.25.5-alpine") | quote }}
                        workingDir: /go/src/homepage-secret-sync
                        command:
                          - sh
                          - -c
                        args:
                          - go run .
                        env:
                          - name: CONFIG_PATH
                            value: /go/src/homepage-secret-sync/config.yaml
                        volumeMounts:
                          - name: config
                            mountPath: /go/src/homepage-secret-sync
                            readOnly: true
                    volumes:
                      - name: config
                        configMap:
                          name: homepage-secret-sync-config
      conditions: {{ $conditions | quote }}
{{- end }}
