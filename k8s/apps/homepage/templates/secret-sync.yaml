{{- $sync := index .Values "secret-sync" | default dict -}}
{{- if (index $sync "enabled") -}}
{{- $output := index $sync "output-secret" | default dict -}}
{{- $outputName := default "homepage-secrets" (index $output "name") -}}
{{- $outputNamespace := default .Release.Namespace (index $output "namespace") -}}
{{- $outputType := index $output "type" -}}
{{- $outputLabels := index $output "labels" -}}
{{- $outputAnnotations := index $output "annotations" -}}
{{- $mappings := index $sync "mappings" | default list -}}
{{- $image := index $sync "image" | default dict -}}
{{- $cron := index $sync "cron" | default dict -}}
{{- $rollout := index $sync "rollout" | default dict -}}
{{- $rolloutEnabled := index $rollout "enabled" | default false -}}
{{- $rolloutNamespace := default $outputNamespace (index $rollout "namespace") -}}
{{- $rolloutDeployment := index $rollout "deployment" -}}
{{- $sourceSecretNames := dict -}}
{{- range $mappings -}}
  {{- $source := index . "source" | default dict -}}
  {{- $name := index $source "name" -}}
  {{- if $name -}}
    {{- $_ := set $sourceSecretNames $name true -}}
  {{- end -}}
{{- end -}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: homepage-secret-sync-config
  namespace: {{ .Release.Namespace }}
data:
  config.yaml: |
    output-secret:
      name: {{ $outputName }}
      namespace: {{ $outputNamespace }}
      {{- if $outputType }}
      type: {{ $outputType }}
      {{- end }}
      {{- if $outputLabels }}
      labels:
{{ toYaml $outputLabels | nindent 8 }}
      {{- end }}
      {{- if $outputAnnotations }}
      annotations:
{{ toYaml $outputAnnotations | nindent 8 }}
      {{- end }}
    mappings:
{{ toYaml $mappings | nindent 6 }}
    {{- if (hasKey $sync "rollout") }}
    rollout:
{{ toYaml $rollout | nindent 6 }}
    {{- end }}
  {{ (.Files.Glob "files/secret-sync/*").AsConfig | nindent 2 }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: homepage-secret-sync
  namespace: {{ .Release.Namespace }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: homepage-secret-sync-reader
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get"]
    {{- if gt (len $sourceSecretNames) 0 }}
    resourceNames:
    {{- range $name, $_ := $sourceSecretNames }}
      - {{ $name }}
    {{- end }}
    {{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: homepage-secret-sync-reader
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: homepage-secret-sync-reader
subjects:
  - kind: ServiceAccount
    name: homepage-secret-sync
    namespace: {{ .Release.Namespace }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: homepage-secret-sync-writer
  namespace: {{ $outputNamespace }}
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames:
      - {{ $outputName }}
    verbs: ["get", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: homepage-secret-sync-writer
  namespace: {{ $outputNamespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: homepage-secret-sync-writer
subjects:
  - kind: ServiceAccount
    name: homepage-secret-sync
    namespace: {{ .Release.Namespace }}
{{- if $rolloutEnabled }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: homepage-secret-sync-rollout
  namespace: {{ $rolloutNamespace }}
rules:
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "patch"]
    {{- if $rolloutDeployment }}
    resourceNames:
      - {{ $rolloutDeployment }}
    {{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: homepage-secret-sync-rollout
  namespace: {{ $rolloutNamespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: homepage-secret-sync-rollout
subjects:
  - kind: ServiceAccount
    name: homepage-secret-sync
    namespace: {{ .Release.Namespace }}
{{- end }}
---
{{- if (index $cron "enabled" | default true) }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: homepage-secret-sync
  namespace: {{ .Release.Namespace }}
spec:
  backoffLimit: 3
  template:
    spec:
      serviceAccountName: homepage-secret-sync
      restartPolicy: OnFailure
      containers:
        - name: sync
          image: {{ printf "%s:%s" (index $image "repository" | default "golang") (index $image "tag" | default "1.25.5-alpine") | quote }}
          workingDir: /go/src/homepage-secret-sync
          command:
            - sh
            - -c
          args:
            - go run .
          env:
            - name: CONFIG_PATH
              value: /go/src/homepage-secret-sync/config.yaml
          volumeMounts:
            - name: config
              mountPath: /go/src/homepage-secret-sync
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: homepage-secret-sync-config
{{- end }}
{{- end }}
