---
apiVersion: batch/v1
kind: Job
metadata:
  name: jellyfin-qbittorrent-password-hash
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: generate-hash
          image: python:3.12-alpine
          command:
            - sh
            - -c
            - |
              python3 <<'EOF'
              import hashlib
              import os
              import base64

              # Get credentials from environment
              password = os.environ['QBITTORRENT_PASSWORD']

              # Generate PBKDF2-SHA512 hash
              salt = os.urandom(16)
              hash_bytes = hashlib.pbkdf2_hmac('sha512', password.encode('utf-8'), salt, 100000)

              # Encode to base64
              salt_b64 = base64.b64encode(salt).decode('ascii')
              hash_b64 = base64.b64encode(hash_bytes).decode('ascii')

              # Format as @ByteArray(salt:hash)
              pbkdf2_string = f"@ByteArray({salt_b64}:{hash_b64})"

              # Write to shared volume
              with open('/shared/password-hash', 'w') as f:
                  f.write(pbkdf2_string)

              print(f"Password hash generated successfully")
              EOF
          env:
            - name: QBITTORRENT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: jellyfin-qbittorrent-admin
                  key: password
          volumeMounts:
            - name: shared
              mountPath: /shared
      containers:
        - name: create-secret
          image: bitnami/kubectl:latest
          command:
            - sh
            - -c
            - |
              HASH=$(cat /shared/password-hash)
              kubectl create secret generic jellyfin-qbittorrent-password-hash \
                --from-literal=hash="$HASH" \
                --dry-run=client -o yaml | kubectl apply -f -
              echo "Secret jellyfin-qbittorrent-password-hash created/updated successfully"
          volumeMounts:
            - name: shared
              mountPath: /shared
      volumes:
        - name: shared
          emptyDir: {}
      serviceAccountName: jellyfin-qbittorrent-password-hash
