---
apiVersion: v1
kind: ConfigMap
metadata:
  name: jellyfin-qbittorrent-update-password
  namespace: {{ .Release.Namespace }}
data:
  update-password.sh: |
    #!/bin/sh
    set -e

    HASH_FILE="/tmp/qbittorrent-password/hash"
    CONFIG_FILE="/config/qBittorrent/qBittorrent.conf"

    # Check if hash file exists
    if [ ! -f "$HASH_FILE" ]; then
      echo "WARNING: Password hash file not found at $HASH_FILE"
      echo "Skipping password update. Run the password hash job first."
      exit 0
    fi

    # Read the hash
    HASH=$(cat "$HASH_FILE")
    echo "Read password hash from secret"

    # Create config directory if it doesn't exist
    mkdir -p /config/qBittorrent

    # Update or create the config file
    if [ -f "$CONFIG_FILE" ]; then
      # Backup existing config
      cp "$CONFIG_FILE" "$CONFIG_FILE.bak"
      echo "Backed up existing config to $CONFIG_FILE.bak"

      # Check if password line already exists
      if grep -q "WebUI\\\\Password_PBKDF2=" "$CONFIG_FILE"; then
        # Replace existing password line
        sed -i "s|WebUI\\\\\\\\Password_PBKDF2=.*|WebUI\\\\\\\\Password_PBKDF2=\"$HASH\"|g" "$CONFIG_FILE"
        echo "Updated existing password in $CONFIG_FILE"
      else
        # Add password line to [Preferences] section
        if grep -q "^\[Preferences\]" "$CONFIG_FILE"; then
          sed -i "/^\[Preferences\]/a WebUI\\\\\\\\Password_PBKDF2=\"$HASH\"" "$CONFIG_FILE"
          echo "Added password to existing [Preferences] section in $CONFIG_FILE"
        else
          # Create [Preferences] section with password
          echo "" >> "$CONFIG_FILE"
          echo "[Preferences]" >> "$CONFIG_FILE"
          echo "WebUI\\\\Password_PBKDF2=\"$HASH\"" >> "$CONFIG_FILE"
          echo "Created [Preferences] section with password in $CONFIG_FILE"
        fi
      fi
    else
      # Create new config file
      echo "[Preferences]" > "$CONFIG_FILE"
      echo "WebUI\\\\Password_PBKDF2=\"$HASH\"" >> "$CONFIG_FILE"
      echo "Created new config file $CONFIG_FILE with password"
    fi

    # Set proper ownership (qBittorrent runs as PUID 1200)
    chown -R 1200:1200 /config/qBittorrent

    echo "Password update completed successfully"
